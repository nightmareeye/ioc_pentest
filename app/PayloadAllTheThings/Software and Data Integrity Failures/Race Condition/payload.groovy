import org.zaproxy.zap.extension.ascan.ActiveScanRule
import org.parosproxy.paros.network.HttpMessage
import org.parosproxy.paros.core.scanner.Alert

class RaceConditionRule extends ActiveScanRule {
    @Override
    public void scan(HttpMessage msg, String param, String value) {
        def raceConditionPayload = "Simultaneous requests to create race condition"
        def newMsg1 = msg.cloneRequest()
        def newMsg2 = msg.cloneRequest()
        sendAndReceive(newMsg1, false)
        sendAndReceive(newMsg2, false)
        if (newMsg1.getResponseBody().toString().contains("race condition detected")) {
            bingo(Alert.RISK_HIGH, Alert.CONFIDENCE_MEDIUM, "Race Condition", "Race condition vulnerability detected.", newMsg1.getRequestHeader().getURI().toString(), param, value, raceConditionPayload, "", newMsg1)
        }
    }
}
